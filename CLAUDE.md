# CLAUDE.md

This file provides guidance to Claude Code when working with code in this repository.

## Project Overview

This project re-implements Autoware's `ndt_scan_matcher` in CUDA and Rust. The reference implementation is at `external/autoware_core/localization/autoware_ndt_scan_matcher/`.

NDT (Normal Distributions Transform) scan matching is used for position estimation in autonomous driving. Key features:
- Estimate position by scan matching against a point cloud map
- Initial position estimation via Monte Carlo method
- Optional regularization using GNSS

## Build System

The project uses `colcon-cargo-ros2` for Rust ROS 2 integration.

```bash
# Install dependencies
pip install -U colcon-cargo-ros2

# Build
just build

# Clean
just clean
```

### Quality Commands

```bash
just format   # Format code with rustfmt
just lint     # Run format check and clippy
just test     # Run tests
just quality  # Run lint + test
```

## Project Structure

```
cuda_ndt_matcher/
├── docs/                        # Design documentation
│   ├── overview.md              # Project goals and strategy
│   ├── architecture.md          # System architecture, ROS interface
│   ├── integration.md           # fast_gicp_rust + cubecl usage
│   └── roadmap.md               # Phased work items with tests
├── external/
│   ├── autoware_core/.../autoware_ndt_scan_matcher/  # C++ reference
│   └── fast_gicp_rust/          # Rust CUDA NDT bindings
│       ├── fast-gicp/           # High-level Rust API
│       └── fast-gicp-sys/       # C++ FFI layer
├── src/                         # Cargo workspace + ROS packages
│   ├── Cargo.toml               # Workspace root
│   └── cuda_ndt_matcher/        # Main ROS package
├── build/                       # Generated by colcon
│   └── ros2_cargo_config.toml
└── justfile
```

## Reference Implementation

The Autoware `ndt_scan_matcher` at `external/autoware_core/localization/autoware_ndt_scan_matcher/` includes:

- `ndt_scan_matcher_core.hpp/cpp`: Main ROS node implementation
- `ndt_omp/`: OpenMP-parallelized NDT algorithm
  - `multigrid_ndt_omp.h`: Multi-grid NDT implementation
  - `multi_voxel_grid_covariance_omp.h`: Voxel grid with covariance
  - `estimate_covariance.hpp`: Covariance estimation methods
- `map_update_module.hpp/cpp`: Dynamic map loading
- `particle.hpp/cpp`: Particle representation for Monte Carlo
- `hyper_parameters.hpp`: Configuration parameters

### Key Algorithms

1. **NDT Scan Matching**: Align sensor point cloud to map using probability distributions
2. **Multi-grid NDT**: Hierarchical approach for faster convergence
3. **Covariance Estimation**: Real-time uncertainty estimation (Laplace, Multi-NDT, Multi-NDT Score)
4. **Regularization**: GNSS-based longitudinal constraint for feature-less environments

## fast_gicp_rust

`external/fast_gicp_rust/` provides Rust bindings for CUDA-accelerated point cloud registration.

**Algorithms:**
- `NDTCuda` - GPU NDT (primary for this project)
- `FastVGICPCuda` - GPU Voxelized GICP
- `FastGICP` / `FastVGICP` - CPU variants

**Usage:** See `docs/integration.md`

**Build:**
```bash
# Requires: libpcl-dev, libeigen3-dev, CUDA 11.0+
cargo build -p fast-gicp --features cuda
```

## Development Notes

- Cargo workspace is at `src/Cargo.toml`, not project root
- ROS packages use `ament_cargo` build type for Rust support
- ROS 2 dependencies (rclrs, *_msgs) are resolved via ament_index by cargo-ros2
- `build/ros2_cargo_config.toml` is generated by colcon and required for standalone cargo commands (clippy, test)
- Run `just build` first to generate the cargo config before running `just lint` or `just test`
- Run colcon build from the project root, not from subdirectories
- Source `install/setup.bash` after building to use the ROS package

## Coding Conventions

- Use named parameters in format strings: `println!("{e}")` not `println!("{}", e)`
- Initialize struct fields before constructing the struct to avoid mutability
- Prefer `Arc<ArcSwap<T>>` over `Arc<Mutex<T>>` for read-heavy concurrent access
- Clone variables in a local scope before moving into closures
